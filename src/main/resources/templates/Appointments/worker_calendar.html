<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Календар на служител</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;0,600;0,700;0,800;0,900&display=swap"
          rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #EBE3D5;
            color: #333;
        }

        .playfair {
            font-family: 'Playfair Display', serif;
        }

        /* Grid styling is now handled by Tailwind classes directly in the HTML */

        .search-select {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            background-color: #fff;
        }

        .options-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 10;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .option {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }

        .option:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="overflow-x-hidden min-h-screen">

<div th:insert="~{fragments/header :: main-header}"></div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-16">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold playfair mb-8 text-center">Календар на служителя</h1>
    <p class="text-lg text-center mb-12 text-gray-700"
       th:text="${'За дата: ' + #temporals.format(currentDate, 'dd MMMM yyyy')}"></p>

    <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
        <div class="flex justify-between items-center mb-4">
            <a th:if="${currentDate.isAfter(today)}"
               th:href="@{'/appointments/worker-calendar' + '?date=' + ${currentDate.minusDays(1)}}"
               class="p-2 rounded-full hover:bg-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
                </svg>
            </a>
            <span th:unless="${currentDate.isAfter(today)}"
                  class="p-2 rounded-full text-gray-400 cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5"/>
                </svg>
            </span>
            <div class="flex flex-col items-center">
                <span class="font-bold text-xl playfair"
                      th:text="${#temporals.format(currentDate, 'dd MMMM yyyy')}"></span>
                <span class="text-gray-500 text-sm mt-1" th:text="${#temporals.dayOfWeekName(currentDate)}"></span>
            </div>
            <button type="button" id="openCalendarBtn" class="p-2 rounded-full hover:bg-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5m18 7.5v-7.5" />
                </svg>
            </button>
            <a th:href="@{'/appointments/worker-calendar' + '?date=' + ${currentDate.plusDays(1)}}"
               class="p-2 rounded-full hover:bg-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                     stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5"/>
                </svg>
            </a>
        </div>

        <div th:if="${isNotAvailable}" class="text-center text-red-500 text-lg font-semibold my-8">
            <p th:text="${notAvailableReason}"></p>
        </div>

        <div th:unless="${isNotAvailable}" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 sm:gap-4 p-1">
            <div th:each="slot : ${timeSlots}"
                 th:with="appointment=${slot.appointment}"
                 class="flex flex-col justify-center items-center text-center p-3 sm:p-4 rounded-lg shadow-sm cursor-pointer transition duration-200 hover:-translate-y-1 hover:shadow-lg"
                 th:classappend="${appointment != null} ?
                                 ( ${appointment.status.name() == 'CONFIRMED' ? 'bg-gray-800 text-white' :
                                    (appointment.status.name() == 'PENDING' ? 'bg-orange-500 text-white' : 'bg-gray-400 text-white')} ) :
                                'bg-white text-gray-700 border border-gray-300'"
                 th:data-slot-id="${appointment != null} ? ${appointment.id} : 'FREE-' + ${#temporals.format(slot.time, 'HH:mm')}"
                 onclick="openSlotModal(this)">

                <span class="font-bold text-lg sm:text-xl" th:text="${#temporals.format(slot.time, 'HH:mm')}"></span>

                <div th:if="${appointment != null}" class="mt-1 text-xs sm:text-sm w-full">
                    <p class="font-semibold truncate"
                       th:text="${appointment.user != null ? appointment.user.name : appointment.username}"
                       th:title="${appointment.user != null ? appointment.user.name : appointment.username}"></p>
                    <p class="opacity-80 truncate"
                       th:text="${appointment.service.name}"
                       th:title="${appointment.service.name}"></p>
                </div>

                <div th:if="${appointment == null}" class="mt-1 text-sm text-gray-500">
                    <p>Свободен</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="slotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-100 p-8 rounded-xl shadow-xl w-full max-w-sm relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
        <h2 class="text-2xl font-bold playfair mb-6" id="modalTitle"></h2>
        <div id="modalContent" class="mb-4"></div>
        <div class="flex justify-end gap-4 mt-6" id="modalButtons">
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const slots = [[${timeSlots}]];
    const services = [[${services}]];
    const workerId = [[${workerId}]];
    const currentDate = [[${currentDate}]];
    const today = [[${today}]];

    function openSlotModal(element) {
        const slotId = element.dataset.slotId;
        const modal = document.getElementById('slotModal');
        const title = document.getElementById('modalTitle');
        const content = document.getElementById('modalContent');
        const modalButtons = document.getElementById('modalButtons');

        // Clear previous content
        modalButtons.innerHTML = '';
        content.innerHTML = '';

        console.log("Clicked on element with slot ID:", slotId);

        if (slotId.startsWith("FREE")) {
            const timeStr = slotId.replace('FREE-', '');
            title.textContent = "Запази час";
            content.innerHTML = `
                <form id="bookForm" method="post" action="/appointments/book">
                    <input type="hidden" name="worker.id" value="${workerId}"/>
                    <input type="hidden" id="startTime" name="startTime" value="${currentDate}T${timeStr}"/>
                    <div class="mb-4">
                        <label for="username" class="block text-gray-700 font-medium mb-1">Име на клиент</label>
                        <input type="text" id="username" name="username" placeholder="Име на клиент" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    </div>
                    <div class="mb-4">
                        <label for="phoneNumber" class="block text-gray-700 font-medium mb-1">Телефон на клиент</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="Телефон на клиент" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                    </div>
                    <div class="mb-4">
                        <label for="service" class="block text-gray-700 font-medium mb-1">Услуга</label>
                        <div class="search-select relative">
                            <input type="text" id="serviceSearch" placeholder="Търсене на услуга..." class="search-input w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <input type="hidden" id="serviceId" name="service.id">
                            <div id="serviceOptions" class="options-container hidden"></div>
                        </div>
                    </div>
                    <div id="validationMessage" class="text-red-500 text-sm mb-4 hidden"></div>
                    <button type="submit" id="submitBtn" class="w-full px-6 py-3 bg-gray-800 text-white font-semibold rounded-full hover:bg-gray-700 transition-colors shadow">Запази</button>
                </form>`;

            const form = document.getElementById('bookForm');
            const serviceSearchInput = document.getElementById('serviceSearch');
            const serviceIdInput = document.getElementById('serviceId');
            const serviceOptionsContainer = document.getElementById('serviceOptions');
            const validationMessage = document.getElementById('validationMessage');

            function renderOptions(filteredServices) {
                serviceOptionsContainer.innerHTML = '';
                if (filteredServices.length === 0) {
                    serviceOptionsContainer.classList.add('hidden');
                    return;
                }
                serviceOptionsContainer.classList.remove('hidden');
                filteredServices.forEach(service => {
                    const option = document.createElement('div');
                    option.className = 'option px-4 py-2 hover:bg-gray-200 cursor-pointer';
                    option.textContent = `${service.name} - ${service.duration} мин.`;
                    option.dataset.id = service.id;
                    option.dataset.duration = service.duration;
                    option.addEventListener('click', () => {
                        serviceIdInput.value = service.id;
                        serviceSearchInput.value = `${service.name} - ${service.duration} мин.`;
                        serviceOptionsContainer.classList.add('hidden');
                    });
                    serviceOptionsContainer.appendChild(option);
                });
            }

            serviceSearchInput.addEventListener('input', (e) => {
                serviceIdInput.value = '';
                const searchTerm = e.target.value.toLowerCase();
                const filteredServices = services.filter(service =>
                    service.name.toLowerCase().includes(searchTerm)
                );
                renderOptions(filteredServices);
            });

            serviceSearchInput.addEventListener('focus', () => {
                renderOptions(services);
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-select')) {
                    serviceOptionsContainer.classList.add('hidden');
                }
            });

            form.addEventListener('submit', (e) => {
                validationMessage.classList.add('hidden');
                if (!serviceIdInput.value) {
                    validationMessage.textContent = 'Моля, изберете услуга от списъка.';
                    validationMessage.classList.remove('hidden');
                    e.preventDefault();
                    return;
                }

                const selectedService = services.find(s => s.id == serviceIdInput.value);
                if (!selectedService) {
                    validationMessage.textContent = 'Избраната услуга не е намерена.';
                    validationMessage.classList.remove('hidden');
                    e.preventDefault();
                    return;
                }

                const duration = selectedService.duration;
                const slotTime = new Date(document.getElementById('startTime').value);
                const startMinutes = slotTime.getHours() * 60 + slotTime.getMinutes();
                const bookedSlotStartTimes = slots
                    .filter(s => s.appointment)
                    .map(s => {
                        const date = new Date(s.appointment.startTime);
                        return date.getHours() * 60 + date.getMinutes();
                    });

                let allSlotsFree = true;
                for (let i = 0; i < duration; i += 30) {
                    const checkMinutes = startMinutes + i;
                    if (bookedSlotStartTimes.includes(checkMinutes)) {
                        allSlotsFree = false;
                        break;
                    }
                }

                if (!allSlotsFree) {
                    validationMessage.textContent = 'Избраната услуга не се побира в този интервал поради вече съществуваща резервация.';
                    validationMessage.classList.remove('hidden');
                    e.preventDefault();
                }
            });

        } else {
            console.log("Searching for appointment with ID:", slotId);
            const appointment = slots.find(s => s.appointment && s.appointment.id === parseInt(slotId))?.appointment;

            if (appointment) {
                console.log("Appointment found:", appointment);
                title.textContent = "Детайли на резервация";
                content.innerHTML = `
                    <div id="appointmentDetails" class="text-gray-700">
                        <p class="mb-2"><span class="font-bold text-gray-800">Клиент:</span> ${appointment.user ? appointment.user.name : appointment.username}</p>
                        <p class="mb-2"><span class="font-bold text-gray-800">Телефон:</span> ${appointment.user ? appointment.user.phoneNumber : appointment.phoneNumber}</p>
                        <p class="mb-2"><span class="font-bold text-gray-800">Услуга:</span> ${appointment.service.name}</p>
                        <p class="mb-2"><span class="font-bold text-gray-800">Статус:</span> ${appointment.status}</p>
                        <p class="mb-2"><span class="font-bold text-gray-800">Време:</span> ${new Date(appointment.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
                    </div>
                `;

                if (appointment.status === 'PENDING') {
                    const acceptBtn = document.createElement('button');
                    acceptBtn.textContent = 'Приеми резервацията';
                    acceptBtn.className = 'px-6 py-2 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors';
                    acceptBtn.onclick = () => {
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = `/appointments/updateStatus/${appointment.id}`;
                        const statusInput = document.createElement('input');
                        statusInput.type = 'hidden';
                        statusInput.name = 'status';
                        statusInput.value = 'CONFIRMED';
                        form.appendChild(statusInput);
                        document.body.appendChild(form);
                        form.submit();
                    };
                    modalButtons.appendChild(acceptBtn);
                }

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Изтрий резервация';
                deleteBtn.className = 'px-6 py-2 bg-red-500 text-white font-semibold rounded-full hover:bg-red-600 transition-colors';
                deleteBtn.onclick = () => {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/appointments/delete';
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'id';
                    input.value = appointment.id;
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                };
                modalButtons.appendChild(deleteBtn);

            } else {
                console.log("Appointment not found for ID:", slotId);
                title.textContent = "Грешка";
                content.innerHTML = "<p>Резервацията не е намерена.</p>";
            }
        }
        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('slotModal').classList.add('hidden');
    }

    // Define Bulgarian locale for Flatpickr
    const bulgarianLocale = {
        weekdays: {
            shorthand: ['Нд', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
            longhand: ['Неделя', 'Понеделник', 'Вторник', 'Сряда', 'Четвъртък', 'Петък', 'Събота'],
        },
        months: {
            shorthand: ['Яну', 'Фев', 'Мар', 'Апр', 'Май', 'Юни', 'Юли', 'Авг', 'Сеп', 'Окт', 'Ное', 'Дек'],
            longhand: ['Януари', 'Февруари', 'Март', 'Април', 'Май', 'Юни', 'Юли', 'Август', 'Септември', 'Октомври', 'Ноември', 'Декември'],
        },
        firstDayOfWeek: 1,
    };

    // Initialize Flatpickr with the custom locale and a minimum date of today
    document.addEventListener("DOMContentLoaded", function() {
        flatpickr("#openCalendarBtn", {
            dateFormat: "Y-m-d",
            defaultDate: currentDate,
            locale: bulgarianLocale,
            minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr) {
                    window.location.href = `/appointments/worker-calendar?date=${dateStr}`;
                }
            }
        });
    });
    /*]]>*/
</script>
</body>
</html>