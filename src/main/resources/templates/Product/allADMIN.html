<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MB Beauty Club - Управление на продукти</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #EBE3D5;
        color: #333;
    }
    .playfair {
        font-family: 'Playfair Display', serif;
    }
  </style>
</head>
<body class="overflow-x-hidden min-h-screen">

<div th:insert="~{fragments/header :: main-header}"></div>

<!-- Dynamic Notification Container -->
<div id="notification-container" class="fixed top-6 right-6 z-50 transition-opacity duration-300">
  <div id="notification-box" class="hidden max-w-sm w-full p-4 rounded-lg shadow-lg flex items-start space-x-3 opacity-0 transform translate-x-10">
    <!-- Icon -->
    <svg id="notification-icon" class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
      <!-- Path will be dynamically updated -->
    </svg>
    <div>
      <h3 id="notification-title" class="text-sm font-semibold"></h3>
      <p id="notification-message" class="mt-1 text-xs"></p>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-16">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold playfair mb-4 sm:mb-0">Управление на продукти</h1>
    <a th:href="@{/products/create}" class="px-6 py-2 bg-gray-800 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors">
      Създай нов продукт
    </a>
  </div>

  <div class="mb-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
    <input type="text" id="searchInput" onkeyup="filterProducts()" placeholder="Търсене по име или описание..." class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all">
    <input type="text" id="barcodeInput" onkeyup="searchByBarcode()" placeholder="Търсене по баркод..." class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all">
  </div>

  <div class="overflow-x-auto bg-white p-6 rounded-xl shadow-lg">
    <table class="min-w-full divide-y divide-gray-200" id="productsTable">
      <thead class="bg-gray-50">
      <tr>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Снимка
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Име
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Описание
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Цена (лв.)
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Цена (€)
        </th>
        <th scope="col" class="px-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Наличност
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Баркод
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Продава се
        </th>
        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          Действия
        </th>
      </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
      <tr th:each="product : ${products}">
        <td class="px-6 py-4 whitespace-nowrap">
          <img th:if="${product.image != null and product.image.length() > 0}" th:src="'data:image/jpeg;base64,' + ${product.image}" alt="Product Image" class="h-16 w-16 object-cover rounded-md">
          <img th:unless="${product.image != null and product.image.length() > 0}" src="https://placehold.co/100x100/C5B099/333333?text=No+Image" alt="No Image" class="h-16 w-16 object-cover rounded-md">
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${product.name}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.description}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.price} + ' лв.'"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${#numbers.formatDecimal(product.euroPrice, 1, 2) + ' €'}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.availableQuantity}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.barcode}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <span th:classappend="${product.forSale} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                                <span th:text="${product.forSale} ? 'Да' : 'Не'"></span>
                            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
          <!-- Updated button styling -->
          <a th:href="@{/products/edit/{id}(id=${product.id})}" class="inline-flex items-center space-x-1 px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-200 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.652.662c-.593.148-1.12.18-1.574-.019A1.875 1.875 0 0 1 1 18.259V16.65a4.5 4.5 0 0 1 1.13-1.897l13.916-13.92Z" />
            </svg>
            <span>Редактирай</span>
          </a>
          <!-- Updated button styling -->
          <form th:action="@{/products/delete/{id}(id=${product.id})}" method="post" class="inline delete-form">
            <button type="button" class="inline-flex items-center space-x-1 px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors delete-button">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.942a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .582.02-.008c.94-.027 1.846-.1 2.72-.213v-.359c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v.359c.874.113 1.78.187 2.72.214m-12.875-3.535a.75.75 0 0 0-1.06 1.06L12 10.94l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 9.94l-1.72-1.72Z" />
              </svg>
              <span>Изтрий</span>
            </button>
          </form>
          <!-- Updated button styling -->
          <form th:action="@{/products/toggle/{id}(id=${product.id})}" method="post" class="inline">
            <button type="submit" class="inline-flex items-center space-x-1 px-3 py-1 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors" title="Превключване на наличност">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15.04l-3.375-3.375L7.29 13.5m14.25 2.25l-.004.004-.375.375a1.125 1.125 0 0 1-1.59 0l-3.375-3.375L12 12.04l-3.375-3.375a1.125 1.125 0 0 0-1.59 0l-.375.375-.004-.004Zm-1.815 6.72a4.5 4.5 0 0 1-7.87-2.673 4.5 4.5 0 0 1 7.87-2.673h-7.87v-1.5H19.5a1.5 1.5 0 0 1 1.5 1.5v1.5a4.5 4.5 0 0 1-7.87 2.673Z" />
              </svg>
              <span>Превключи</span>
            </button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmation-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-gray-900 bg-opacity-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
    <h3 class="text-lg font-bold mb-2 text-gray-800">Потвърждение</h3>
    <p class="text-sm text-gray-600 mb-6">Сигурни ли сте, че искате да изтриете този продукт?</p>
    <div class="flex justify-end space-x-4">
      <button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Отказ</button>
      <button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-full hover:bg-red-700 transition-colors">Изтрий</button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {

      // Notification logic
      const notificationContainer = document.getElementById('notification-container');
      const notificationBox = document.getElementById('notification-box');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      const notificationIcon = document.getElementById('notification-icon');

      const successMessage = /*[[${successMessage}]]*/ '';
      const errorMessage = /*[[${errorMessage}]]*/ '';

      function showNotification(title, message, type) {
          notificationTitle.textContent = title;
          notificationMessage.textContent = message;

          let iconPath;
          let boxColor;

          if (type === 'success') {
              boxColor = 'bg-gray-100 text-gray-800';
              iconPath = '<path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.882L10.25 11.25l-1.5-1.5a.75.75 0 1 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l4-4Z" clip-rule="evenodd" />';
              notificationBox.classList.remove('bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
              notificationBox.classList.add(boxColor);
          } else if (type === 'error') {
              boxColor = 'bg-gray-100 text-gray-800';
              iconPath = '<path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />';
              notificationBox.classList.remove('bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
              notificationBox.classList.add(boxColor);
          }
          notificationIcon.innerHTML = iconPath;

          notificationBox.classList.remove('hidden');
          setTimeout(() => {
              notificationBox.classList.remove('opacity-0', 'translate-x-10');
              notificationBox.classList.add('opacity-100', 'translate-x-0');
          }, 100);

          setTimeout(() => {
              notificationBox.classList.remove('opacity-100', 'translate-x-0');
              notificationBox.classList.add('opacity-0', 'translate-x-10');
              setTimeout(() => {
                  notificationBox.classList.add('hidden');
              }, 300);
          }, 3000);
      }

      if (successMessage && successMessage.trim().length > 0) {
          showNotification('Perfect', successMessage, 'success');
      } else if (errorMessage && errorMessage.trim().length > 0) {
          showNotification('Error Occurred', errorMessage, 'error');
      }

      // Modal logic
      const modal = document.getElementById('confirmation-modal');
      const confirmButton = document.getElementById('modal-confirm');
      const cancelButton = document.getElementById('modal-cancel');
      let formToSubmit = null;

      document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (event) => {
              event.preventDefault();
              formToSubmit = button.closest('form');
              modal.classList.remove('hidden');
              modal.classList.add('flex');
              document.body.style.overflow = 'hidden';
          });
      });

      confirmButton.addEventListener('click', () => {
          if (formToSubmit) {
              formToSubmit.submit();
          }
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = 'auto';
      });

      cancelButton.addEventListener('click', () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = 'auto';
      });
  });

  function filterProducts() {
      let input = document.getElementById("searchInput");
      let filter = input.value.toLowerCase();
      let table = document.getElementById("productsTable");
      let tr = table.getElementsByTagName("tr");

      document.getElementById("barcodeInput").value = ''; // Clear barcode search on text search

      for (let i = 1; i < tr.length; i++) { // Start at 1 to skip the header row
          let nameTd = tr[i].getElementsByTagName("td")[1];
          let descTd = tr[i].getElementsByTagName("td")[2];
          if (nameTd || descTd) {
              let nameText = nameTd.textContent || nameTd.innerText;
              let descText = descTd.textContent || descTd.innerText;
              if (nameText.toLowerCase().indexOf(filter) > -1 || descText.toLowerCase().indexOf(filter) > -1) {
                  tr[i].style.display = "";
              } else {
                  tr[i].style.display = "none";
              }
          }
      }
  }

  function searchByBarcode() {
      let input = document.getElementById("barcodeInput");
      let filter = input.value.trim();
      let table = document.getElementById("productsTable");
      let tr = table.getElementsByTagName("tr");

      document.getElementById("searchInput").value = ''; // Clear text search on barcode search

      for (let i = 1; i < tr.length; i++) {
          let barcodeTd = tr[i].getElementsByTagName("td")[5];
          if (barcodeTd) {
              let barcodeText = barcodeTd.textContent || barcodeTd.innerText;
              if (barcodeText.indexOf(filter) > -1) {
                  tr[i].style.display = "";
              } else {
                  tr[i].style.display = "none";
              }
          }
      }
  }
</script>
</body>
</html>
