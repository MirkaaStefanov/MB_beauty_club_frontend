<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MB Beauty Club - Управление на продукти</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #EBE3D5;
        color: #333;
    }
    .playfair {
        font-family: 'Playfair Display', serif;
    }
  </style>
</head>
<body class="overflow-x-hidden min-h-screen">

<div th:insert="~{fragments/header :: main-header}"></div>

<div id="notification-container" class="fixed top-6 right-6 z-50 transition-opacity duration-300">
  <div id="notification-box" class="hidden max-w-sm w-full p-4 rounded-lg shadow-lg flex items-start space-x-3 opacity-0 transform translate-x-10">
    <svg id="notification-icon" class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
    </svg>
    <div>
      <h3 id="notification-title" class="text-sm font-semibold"></h3>
      <p id="notification-message" class="mt-1 text-xs"></p>
    </div>
  </div>
</div>

<div class="container mx-auto px-4 sm:px-6 lg:px-8 pt-32 pb-16">
  <div class="flex flex-col sm:flex-row justify-between items-center mb-8">
    <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold playfair mb-4 sm:mb-0">Управление на продукти</h1>
    <a th:href="@{/products/create}" class="px-6 py-2 bg-gray-800 text-white rounded-full font-semibold hover:bg-gray-700 transition-colors">
      Създай нов продукт
    </a>
  </div>

  <div class="mb-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
    <input type="text" id="searchInput" onkeyup="filterProducts()" placeholder="Търсене по име или описание..." class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all">
    <input type="text" id="barcodeInput" onkeyup="searchByBarcode()" placeholder="Търсене по баркод..." class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-800 focus:border-transparent transition-all">
  </div>

  <div class="mb-6 flex flex-wrap gap-2 justify-center sm:justify-start">
    <button data-filter="promotion" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
      Промоционални
    </button>
    <button data-filter="forSale" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
      За продажба
    </button>
    <button data-filter="lowQuantity" class="filter-btn px-4 py-2 bg-gray-200 text-gray-700 rounded-full font-medium hover:bg-gray-300 transition-colors">
      Ниска наличност
    </button>
    <button onclick="clearFilters()" class="px-4 py-2 bg-gray-800 text-white rounded-full font-medium hover:bg-gray-700 transition-colors">
      Покажи всички
    </button>
  </div>


  <div class="overflow-x-auto bg-white p-6 rounded-xl shadow-lg">
    <table class="min-w-full divide-y divide-gray-200" id="productsTable">
      <thead class="bg-gray-50">
      <tr>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Снимка
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Име
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Описание
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Цена (лв.)
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Цена (€)
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Входяща Цена
        </th>
        <th scope="col" class="px-col px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Наличност
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Баркод
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Продава се
        </th>
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
          Промоция
        </th>
        <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
          Действия
        </th>
      </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
      <tr th:each="product : ${products}"
          th:data-promotion="${product.promotion}"
          th:data-for-sale="${product.forSale}"
          th:data-quantity="${product.availableQuantity}">

        <td class="px-6 py-4 whitespace-nowrap">
          <img th:if="${product.image != null and product.image.length() > 0}" th:src="'data:image/jpeg;base64,' + ${product.image}" alt="Product Image" class="h-16 w-16 object-cover rounded-md">
          <img th:unless="${product.image != null and product.image.length() > 0}" src="https://placehold.co/100x100/C5B099/333333?text=No+Image" alt="No Image" class="h-16 w-16 object-cover rounded-md">
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" th:text="${product.name}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.description}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          <div th:if="${product.promotionPrice != null}">
            <span class="text-gray-400 line-through" th:text="${#numbers.formatDecimal(product.price, 1, 2) + ' лв.'}"></span>
            <span class="text-green-600 font-semibold ml-2" th:text="${#numbers.formatDecimal(product.promotionPrice, 1, 2) + ' лв.'}"></span>
          </div>
          <span th:if="${product.promotionPrice == null}" th:text="${#numbers.formatDecimal(product.price, 1, 2) + ' лв.'}"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          <div th:if="${product.promotionEuroPrice != null}">
            <span class="text-gray-400 line-through" th:text="${#numbers.formatDecimal(product.euroPrice, 1, 2) + ' €'}"></span>
            <span class="text-green-600 font-semibold ml-2" th:text="${#numbers.formatDecimal(product.promotionEuroPrice, 1, 2) + ' €'}"></span>
          </div>
          <span th:if="${product.promotionEuroPrice == null}" th:text="${#numbers.formatDecimal(product.euroPrice, 1, 2) + ' €'}"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
          <span th:text="${product.comingPrice != null ? #numbers.formatDecimal(product.comingPrice, 1, 2) + ' лв.' : '-'}"></span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm flex flex-col items-center justify-center">
            <span th:classappend="${product.availableQuantity < 10} ? 'text-red-600 font-bold' : (${product.availableQuantity > 50} ? 'text-green-600 font-bold' : 'text-orange-600 font-bold')"
                  th:text="${product.availableQuantity}">
            </span>
          <a th:href="@{/products/restock/{id}(id=${product.id})}" class="mt-2 inline-flex items-center space-x-1 px-3 py-1 bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 4.875a2.25 2.25 0 014.5 0M18.75 6.75h-13.5A2.25 2.25 0 003 9h18a2.25 2.25 0 00-2.25-2.25z" />
            </svg>
            <span>Зареди</span>
          </a>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" th:text="${product.barcode}"></td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
            <span th:classappend="${product.forSale} ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                <span th:text="${product.forSale} ? 'Да' : 'Не'"></span>
            </span>
          <form th:action="@{/products/toggle/{id}(id=${product.id})}" method="post" class="inline mt-2">
            <button type="submit" class="inline-flex items-center space-x-1 px-3 py-1 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors" title="Превключване на наличност">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0l4.5-4.5M3 16.5h18" />
              </svg>
              <span>Превключи</span>
            </button>
          </form>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
          <div th:if="${!product.promotion}">
            <a th:href="@{/products/promote/{id}(id=${product.id})}" class="inline-flex items-center space-x-1 px-3 py-1 bg-green-100 text-green-600 rounded-full hover:bg-green-200 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 0110.638 3.286c-.524.23-.974.62-1.332 1.107L9 5.5l-.307.727a8.217 8.217 0 01-1.217 1.84c-.694.75-1.34 1.48-1.92 2.19l-.36.438c-.372.45-1.042.842-1.662.972l-.183.037a1.5 1.5 0 00-.773 2.106l1.24 1.76a1.5 1.5 0 01-.132 1.956L4.722 17.5a1.5 1.5 0 001.956.132l1.76-1.24a1.5 1.5 0 012.106.773l.037.183c.13.62.522 1.29.972 1.662l.438.36c.71.58 1.44 1.226 2.19 1.92a8.217 8.217 0 011.84 1.217L19.5 21l.727-.307a8.25 8.25 0 011.107-1.332l.727-.307c.45-.188.842-1.042.972-1.662l.037-.183a1.5 1.5 0 00-.773-2.106l-1.76-1.24a1.5 1.5 0 01-.773-2.106l1.24-1.76a1.5 1.5 0 00-2.106-.773l-.183-.037a1.5 1.5 0 00-1.662-.972l-.36-.438c-.58-.71-1.226-1.44-1.92-2.19a8.217 8.217 0 01-1.217-1.84l-.307-.727z" />
              </svg>
              <span>Промоция</span>
            </a>
          </div>
          <div th:if="${product.promotion}">
                <span th:classappend="${product.promotion} ? 'bg-orange-100 text-orange-800' : ''" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                    <span th:text="${product.promotion} ? ${product.percent} + '%' : 'Няма'"></span>
                </span>
            <form th:action="@{/products/{id}/remove-promote(id=${product.id})}" method="post" class="inline mt-2">
              <button type="submit" class="inline-flex items-center space-x-1 px-3 py-1 bg-orange-100 text-orange-600 rounded-full hover:bg-orange-200 transition-colors" title="Премахни промоцията">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 9.75l4.5 4.5m0-4.5l-4.5 4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Премахни</span>
              </button>
            </form>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2 flex flex-wrap justify-end items-center gap-2">
          <a th:href="@{/products/edit/{id}(id=${product.id})}" class="inline-flex items-center space-x-1 px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full hover:bg-indigo-200 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.652.662c-.593.148-1.12.18-1.574-.019A1.875 1.875 0 0 1 1 18.259V16.65a4.5 4.5 0 0 1 1.13-1.897l13.916-13.92Z" />
            </svg>
            <span>Редактирай</span>
          </a>
          <form th:action="@{/products/delete/{id}(id=${product.id})}" method="post" class="inline delete-form">
            <button type="button" class="inline-flex items-center space-x-1 px-3 py-1 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors delete-button">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.942a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .582.02-.008c.94-.027 1.846-.1 2.72-.213v-.359c0-.621.504-1.125 1.125-1.125h4.5c.621 0 1.125.504 1.125 1.125v.359c.874.113 1.78.187 2.72.214m-12.875-3.535a.75.75 0 0 0-1.06 1.06L12 10.94l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 9.94l-1.72-1.72Z" />
              </svg>
              <span>Изтрий</span>
            </button>
          </form>
        </td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<div id="confirmation-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-gray-900 bg-opacity-50">
  <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
    <h3 class="text-lg font-bold mb-2 text-gray-800">Потвърждение</h3>
    <p class="text-sm text-gray-600 mb-6">Сигурни ли сте, че искате да изтриете този продукт?</p>
    <div class="flex justify-end space-x-4">
      <button id="modal-cancel" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">Отказ</button>
      <button id="modal-confirm" class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-full hover:bg-red-700 transition-colors">Изтрий</button>
    </div>
  </div>
</div>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {

      // Notification logic
      const notificationContainer = document.getElementById('notification-container');
      const notificationBox = document.getElementById('notification-box');
      const notificationTitle = document.getElementById('notification-title');
      const notificationMessage = document.getElementById('notification-message');
      const notificationIcon = document.getElementById('notification-icon');

      const successMessage = /*[[${successMessage}]]*/ '';
      const errorMessage = /*[[${errorMessage}]]*/ '';

      function showNotification(title, message, type) {
          notificationTitle.textContent = title;
          notificationMessage.textContent = message;

          let iconPath;
          let boxColor;

          if (type === 'success') {
              boxColor = 'bg-gray-100 text-gray-800';
              iconPath = '<path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75S17.385 21.75 12 21.75 2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.882L10.25 11.25l-1.5-1.5a.75.75 0 1 0-1.06 1.06l2 2a.75.75 0 0 0 1.06 0l4-4Z" clip-rule="evenodd" />';
              notificationBox.classList.remove('bg-red-50', 'text-red-700', 'bg-green-50', 'text-green-700');
              notificationBox.classList.add(boxColor);
          } else if (type === 'error') {
              boxColor = 'bg-gray-100 text-gray-800';
              iconPath = '<path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />';
              notificationBox.classList.remove('bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
              notificationBox.classList.add(boxColor);
          }
          notificationIcon.innerHTML = iconPath;

          notificationBox.classList.remove('hidden');
          setTimeout(() => {
              notificationBox.classList.remove('opacity-0', 'translate-x-10');
              notificationBox.classList.add('opacity-100', 'translate-x-0');
          }, 100);

          setTimeout(() => {
              notificationBox.classList.remove('opacity-100', 'translate-x-0');
              notificationBox.classList.add('opacity-0', 'translate-x-10');
              setTimeout(() => {
                  notificationBox.classList.add('hidden');
              }, 300);
          }, 3000);
      }

      if (successMessage && successMessage.trim().length > 0) {
          showNotification('Perfect', successMessage, 'success');
      } else if (errorMessage && errorMessage.trim().length > 0) {
          showNotification('Error Occurred', errorMessage, 'error');
      }

      // Modal logic
      const modal = document.getElementById('confirmation-modal');
      const confirmButton = document.getElementById('modal-confirm');
      const cancelButton = document.getElementById('modal-cancel');
      let formToSubmit = null;

      document.querySelectorAll('.delete-button').forEach(button => {
          button.addEventListener('click', (event) => {
              event.preventDefault();
              formToSubmit = button.closest('form');
              modal.classList.remove('hidden');
              modal.classList.add('flex');
              document.body.style.overflow = 'hidden';
          });
      });

      confirmButton.addEventListener('click', () => {
          if (formToSubmit) {
              formToSubmit.submit();
          }
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = 'auto';
      });

      cancelButton.addEventListener('click', () => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = 'auto';
      });


      const filterButtons = document.querySelectorAll('.filter-btn');
      const productsTable = document.getElementById('productsTable');
      const rows = Array.from(productsTable.getElementsByTagName('tr')).slice(1); // Exclude the header row

      filterButtons.forEach(button => {
          button.addEventListener('click', () => {
              // Toggle the active state of the clicked button
              button.classList.toggle('bg-gray-800');
              button.classList.toggle('text-white');
              button.classList.toggle('bg-gray-200');
              button.classList.toggle('text-gray-700');

              // Run the filtering logic
              applyFilters();
          });
      });

      function applyFilters() {
          const activeFilters = document.querySelectorAll('.filter-btn.bg-gray-800');
          const activeFilterTypes = Array.from(activeFilters).map(btn => btn.getAttribute('data-filter'));

          // Clear any text search inputs
          document.getElementById('searchInput').value = '';
          document.getElementById('barcodeInput').value = '';

          rows.forEach(row => {
              const isPromotion = row.getAttribute('data-promotion') === 'true';
              const isForSale = row.getAttribute('data-for-sale') === 'true';
              const quantity = parseInt(row.getAttribute('data-quantity'));

              let shouldShow = true;

              if (activeFilterTypes.includes('promotion') && !isPromotion) {
                  shouldShow = false;
              }
              if (activeFilterTypes.includes('forSale') && !isForSale) {
                  shouldShow = false;
              }
              if (activeFilterTypes.includes('lowQuantity') && quantity >= 10) {
                  shouldShow = false;
              }

              row.style.display = shouldShow ? '' : 'none';
          });
      }

      window.clearFilters = function() {
          filterButtons.forEach(button => {
              button.classList.remove('bg-gray-800', 'text-white');
              button.classList.add('bg-gray-200', 'text-gray-700');
          });
          rows.forEach(row => row.style.display = '');
      }

      window.filterProducts = function() {
          clearFilters();
          let input = document.getElementById("searchInput");
          let filter = input.value.toLowerCase();
          let tr = productsTable.getElementsByTagName("tr");

          for (let i = 1; i < tr.length; i++) {
              let nameTd = tr[i].getElementsByTagName("td")[1];
              let descTd = tr[i].getElementsByTagName("td")[2];
              if (nameTd || descTd) {
                  let nameText = nameTd.textContent || nameTd.innerText;
                  let descText = descTd.textContent || descTd.innerText;
                  if (nameText.toLowerCase().indexOf(filter) > -1 || descText.toLowerCase().indexOf(filter) > -1) {
                      tr[i].style.display = "";
                  } else {
                      tr[i].style.display = "none";
                  }
              }
          }
      }

      window.searchByBarcode = function() {
          clearFilters();
          let input = document.getElementById("barcodeInput");
          let filter = input.value.trim();
          let tr = productsTable.getElementsByTagName("tr");

          for (let i = 1; i < tr.length; i++) {
              let barcodeTd = tr[i].getElementsByTagName("td")[6];
              if (barcodeTd) {
                  let barcodeText = barcodeTd.textContent || barcodeTd.innerText;
                  if (barcodeText.indexOf(filter) > -1) {
                      tr[i].style.display = "";
                  } else {
                      tr[i].style.display = "none";
                  }
              }
          }
      }
  });
</script>
</body>
</html>