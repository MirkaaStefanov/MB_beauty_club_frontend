<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js for graphics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html {
        scroll-behavior: smooth;
    }
    body {
        font-family: 'Poppins', sans-serif;
        background-color: #F8F4F2;
        color: #333;
    }
    .playfair {
        font-family: 'Playfair Display', serif;
    }
    .card {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 24px;
        transition: transform 0.2s;
    }
    .card:hover {
        transform: translateY(-5px);
    }
  </style>
</head>
<body class="overflow-x-hidden">

<div th:insert="~{fragments/header :: main-header}"></div>

<main>
  <section class="pt-8 sm:pt-10 pb-16 sm:pb-24 bg-[#EBE3D5] min-h-screen">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <h1 class="text-3xl md:text-4xl font-bold playfair text-gray-800 mb-6">Табло за управление</h1>
      <p class="text-gray-600 mb-10">Преглед на данните за поръчките и продуктите.</p>

      <!-- Time Filters -->
      <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
        <h2 class="text-xl font-semibold text-gray-700">Филтър по време</h2>
        <div class="flex space-x-2">
          <button id="filter-day" class="px-4 py-2 rounded-full font-semibold text-white bg-gray-800 hover:bg-gray-700 transition">Днес</button>
          <button id="filter-month" class="px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Месец</button>
          <button id="filter-year" class="px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition">Година</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="card">
          <p class="text-sm text-gray-500 uppercase font-bold">Спечелени пари</p>
          <p id="total-earnings" class="text-4xl font-bold text-gray-900 mt-2">...лв</p>
        </div>
        <div class="card">
          <p class="text-sm text-gray-500 uppercase font-bold">Поръчки в очакване</p>
          <p id="pending-orders" class="text-4xl font-bold text-yellow-500 mt-2">0</p>
        </div>
        <div class="card">
          <p class="text-sm text-gray-500 uppercase font-bold">Поръчки за доставка</p>
          <p id="deliver-orders" class="text-4xl font-bold text-green-500 mt-2">0</p>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Earnings Chart -->
        <div class="card">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Спечелени пари</h2>
          <canvas id="earningsChart"></canvas>
        </div>

        <!-- Most Ordered Products Chart -->
        <div class="card">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Най-поръчвани продукти</h2>
          <canvas id="mostOrderedProductsChart"></canvas>
        </div>

        <!-- Order Status Pie Chart -->
        <div class="card md:col-span-2 flex items-center justify-center p-6">
          <div class="w-full max-w-sm">
            <h2 class="text-xl text-center font-semibold text-gray-700 mb-4">Статус на поръчките</h2>
            <canvas id="orderStatusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer th:insert="~{fragments/footer :: main-footer}"></footer>

<script th:inline="javascript">
  document.addEventListener('DOMContentLoaded', () => {

      // Get data from the Thymeleaf model
      const allOrders = /*[[${orders}]]*/ [];
      const allOrderProducts = /*[[${orderProducts}]]*/ [];

      let earningsChart, orderStatusChart, mostOrderedProductsChart;
      const filterButtons = {
          day: document.getElementById('filter-day'),
          month: document.getElementById('filter-month'),
          year: document.getElementById('filter-year')
      };
      const summaryElements = {
          totalEarnings: document.getElementById('total-earnings'),
          pendingOrders: document.getElementById('pending-orders'),
          deliverOrders: document.getElementById('deliver-orders')
      };

      // Calculate total earnings from DONE orders
      const calculateTotalEarnings = (orders) => {
          return orders
              .filter(order => order.status === "DONE")
              .reduce((sum, order) => sum + (parseFloat(order.price) || 0), 0)
              .toFixed(2);
      };

      // Count orders by status
      const countOrdersByStatus = (orders) => {
          const statusCounts = { PENDING: 0, DELIVER: 0, DONE: 0 };
          orders.forEach(order => {
              if (statusCounts.hasOwnProperty(order.status)) {
                  statusCounts[order.status]++;
              }
          });
          return statusCounts;
      };

      // Find most ordered products
      const getMostOrderedProducts = (orderProducts) => {
          const productCounts = {};
          orderProducts.forEach(op => {
              const productName = op.product.name;
              productCounts[productName] = (productCounts[productName] || 0) + op.quantity;
          });
          return Object.entries(productCounts)
              .sort(([, a], [, b]) => b - a)
              .slice(0, 10)
              .map(([name, quantity]) => ({ name, quantity }));
      };

      // Update summary cards
      const updateSummaryCards = (orders) => {
          const statusCounts = countOrdersByStatus(orders);
          summaryElements.totalEarnings.textContent = `${calculateTotalEarnings(orders)} лв`;
          summaryElements.pendingOrders.textContent = statusCounts.PENDING;
          summaryElements.deliverOrders.textContent = statusCounts.DELIVER;
      };

      // Update charts with new data
      const updateCharts = (orders) => {
          const statusCounts = countOrdersByStatus(orders);
          const mostOrdered = getMostOrderedProducts(allOrderProducts);
          const earningsData = calculateEarningsForChart(orders);

          if (earningsChart) {
              earningsChart.data.labels = earningsData.labels;
              earningsChart.data.datasets[0].data = earningsData.data;
              earningsChart.update();
          }

          if (orderStatusChart) {
              orderStatusChart.data.datasets[0].data = [statusCounts.PENDING, statusCounts.DELIVER, statusCounts.DONE];
              orderStatusChart.update();
          }

          if (mostOrderedProductsChart) {
              mostOrderedProductsChart.data.labels = mostOrdered.map(p => p.name);
              mostOrderedProductsChart.data.datasets[0].data = mostOrdered.map(p => p.quantity);
              mostOrderedProductsChart.update();
          }
      };

      // Filter data based on time range
      const filterData = (range) => {
          const currentDate = new Date();
          let filteredOrders = [];

          if (range === 'day') {
              filteredOrders = allOrders.filter(order => {
                  const orderDate = new Date(order.orderDate);
                  return orderDate.getFullYear() === currentDate.getFullYear() &&
                         orderDate.getMonth() === currentDate.getMonth() &&
                         orderDate.getDate() === currentDate.getDate();
              });
          } else if (range === 'month') {
              filteredOrders = allOrders.filter(order => {
                  const orderDate = new Date(order.orderDate);
                  return orderDate.getFullYear() === currentDate.getFullYear() &&
                         orderDate.getMonth() === currentDate.getMonth();
              });
          } else if (range === 'year') {
              filteredOrders = allOrders.filter(order => {
                  const orderDate = new Date(order.orderDate);
                  return orderDate.getFullYear() === currentDate.getFullYear();
              });
          } else {
              filteredOrders = allOrders; // All time
          }

          updateSummaryCards(filteredOrders);
          updateCharts(filteredOrders);
      };

      // Helper to calculate data for the earnings chart
      const calculateEarningsForChart = (orders) => {
          const earningsByDate = {};
          orders.filter(o => o.status === "DONE").forEach(order => {
              const date = order.orderDate;
              if (!earningsByDate[date]) {
                  earningsByDate[date] = 0;
              }
              earningsByDate[date] += parseFloat(order.price);
          });

          const sortedDates = Object.keys(earningsByDate).sort();
          const labels = sortedDates;
          const data = sortedDates.map(date => earningsByDate[date]);

          return { labels, data };
      };

      // Initial chart rendering
      const renderCharts = () => {
          const earningsCtx = document.getElementById('earningsChart').getContext('2d');
          const initialEarningsData = calculateEarningsForChart(allOrders);
          earningsChart = new Chart(earningsCtx, {
              type: 'line',
              data: {
                  labels: initialEarningsData.labels,
                  datasets: [{
                      label: 'Спечелени пари (лв)',
                      data: initialEarningsData.data,
                      borderColor: '#C5B099',
                      backgroundColor: 'rgba(197, 176, 153, 0.2)',
                      tension: 0.1,
                      fill: true,
                  }]
              },
              options: {
                  responsive: true,
                  scales: {
                      y: {
                          beginAtZero: true,
                          title: {
                              display: true,
                              text: 'Лева'
                          }
                      },
                      x: {
                          title: {
                              display: true,
                              text: 'Дата'
                          }
                      }
                  },
                  plugins: {
                      legend: {
                          display: false
                      }
                  }
              }
          });

          const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
          const initialStatusCounts = countOrdersByStatus(allOrders);
          orderStatusChart = new Chart(statusCtx, {
              type: 'pie',
              data: {
                  labels: ['Очакващи', 'Доставени', 'Приключени'],
                  datasets: [{
                      data: [initialStatusCounts.PENDING, initialStatusCounts.DELIVER, initialStatusCounts.DONE],
                      backgroundColor: ['#fde047', '#4ade80', '#2563eb'],
                      hoverOffset: 4
                  }]
              },
              options: {
                  responsive: true,
                  plugins: {
                      legend: {
                          position: 'top',
                      }
                  }
              }
          });

          const productsCtx = document.getElementById('mostOrderedProductsChart').getContext('2d');
          const initialMostOrdered = getMostOrderedProducts(allOrderProducts);
          mostOrderedProductsChart = new Chart(productsCtx, {
              type: 'bar',
              data: {
                  labels: initialMostOrdered.map(p => p.name),
                  datasets: [{
                      label: 'Брой поръчки',
                      data: initialMostOrdered.map(p => p.quantity),
                      backgroundColor: '#C5B099',
                      borderColor: '#EBE3D5',
                      borderWidth: 1
                  }]
              },
              options: {
                  responsive: true,
                  indexAxis: 'y',
                  scales: {
                      x: {
                          beginAtZero: true
                      }
                  },
                  plugins: {
                      legend: {
                          display: false
                      }
                  }
              }
          });
      };

      filterButtons.day.addEventListener('click', () => {
          filterData('day');
          Object.values(filterButtons).forEach(btn => btn.className = 'px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition');
          filterButtons.day.className = 'px-4 py-2 rounded-full font-semibold text-white bg-gray-800 hover:bg-gray-700 transition';
      });
      filterButtons.month.addEventListener('click', () => {
          filterData('month');
          Object.values(filterButtons).forEach(btn => btn.className = 'px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition');
          filterButtons.month.className = 'px-4 py-2 rounded-full font-semibold text-white bg-gray-800 hover:bg-gray-700 transition';
      });
      filterButtons.year.addEventListener('click', () => {
          filterData('year');
          Object.values(filterButtons).forEach(btn => btn.className = 'px-4 py-2 rounded-full font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition');
          filterButtons.year.className = 'px-4 py-2 rounded-full font-semibold text-white bg-gray-800 hover:bg-gray-700 transition';
      });

      updateSummaryCards(allOrders);
      renderCharts();
  });
</script>
</body>
</html>
